name: Deploy Frontend to Azure Static Web Apps

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

env:
  NEXT_PUBLIC_API_URL: https://app-screenshare-dev.azurewebsites.net
  NEXT_PUBLIC_WS_URL: wss://app-screenshare-dev.azurewebsites.net

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    name: Build and Deploy Frontend
    steps:
      - uses: actions/checkout@v4

      - uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Build frontend
        run: bun run --filter @screenshare-guide/web build

      - name: Fix standalone node_modules (replace bun symlinks with real copies)
        run: |
          STANDALONE=apps/web/.next/standalone
          
          # Bun creates relative symlinks in standalone/node_modules/ that point
          # back to the workspace root node_modules/.bun/ cache. These are broken
          # because standalone doesn't mirror the full monorepo directory tree.
          # Fix: delete symlinks and copy the real resolved packages from workspace.
          
          find "$STANDALONE" -type l | while IFS= read -r link; do
            pkg_name=$(basename "$link")
            rm "$link"
            
            # Find the real package in workspace node_modules
            if [ -d "node_modules/$pkg_name" ]; then
              cp -rL "node_modules/$pkg_name" "$link"
              echo "Resolved: $pkg_name from workspace root"
            elif [ -d "apps/web/node_modules/$pkg_name" ]; then
              cp -rL "apps/web/node_modules/$pkg_name" "$link"
              echo "Resolved: $pkg_name from apps/web"
            else
              echo "WARNING: Could not find $pkg_name"
            fi
          done
          
          # Copy static assets required by Next.js standalone
          mkdir -p "$STANDALONE/apps/web/public"
          cp -r apps/web/public/* "$STANDALONE/apps/web/public/" 2>/dev/null || true
          mkdir -p "$STANDALONE/apps/web/.next"
          cp -r apps/web/.next/static "$STANDALONE/apps/web/.next/static"
          
          # Verify no symlinks remain
          remaining=$(find "$STANDALONE" -type l | wc -l)
          echo "Remaining symlinks: $remaining"

      - name: Deploy to Azure Static Web Apps
        uses: Azure/static-web-apps-deploy@v1
        with:
          azure_static_web_apps_api_token: ${{ secrets.SWA_DEPLOYMENT_TOKEN }}
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          action: "upload"
          app_location: "apps/web"
          skip_app_build: true
